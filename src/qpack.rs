use std::{
    mem,
    ops::Range,
    pin::Pin,
    sync::OnceLock,
    task::{Context, Poll, ready},
};

use bytes::{BufMut, Bytes, BytesMut};
use futures::{AsyncBufRead, AsyncRead};

use crate::codec::{DecodeError, DecodeStreamError};

pub struct DecodingInteger {
    n: u8,
    i: u64,
    m: u32,
}

impl DecodingInteger {
    pub const fn new(prefix: u8, n: u8) -> Result<Self, u64> {
        let mask = (1u8 << n) - 1;
        match prefix & mask {
            i if i == mask => Ok(Self {
                n,
                i: i as u64,
                m: 0,
            }),
            i => Err(i as u64),
        }
    }

    /// Pseudocode to decode an integer I is as follows:
    /// ```code
    ///   decode I from the next N bits
    ///   if I < 2^N - 1, return I
    ///   else
    ///       M = 0
    ///       repeat
    ///           B = next octet
    ///           I = I + (B & 127) * 2^M
    ///           M = M + 7
    ///       while B & 128 == 128
    ///       return I
    /// ```
    pub fn poll_decode(
        &mut self,
        stream: &mut (impl AsyncRead + Unpin),
        cx: &mut Context<'_>,
    ) -> Poll<Result<u64, DecodeStreamError>> {
        debug_assert!(
            !(self.m == 0 && self.i < (1u64 << self.n) - 1),
            "No need to decode"
        );

        let mut buf = [0; 1];
        loop {
            match ready!(Pin::new(&mut *stream).poll_read(cx, &mut buf))
                .map_err(DecodeStreamError::from_io_error)?
            {
                0 => return Poll::Ready(Err(DecodeError::Incomplete.into())),
                i => debug_assert!(i == 1),
            };

            let addend = (buf[0] as u64 & 127)
                .checked_shl(self.m)
                .ok_or(DecodeError::IntegerOverflow)?;
            self.i = self
                .i
                .checked_add(addend)
                .ok_or(DecodeError::IntegerOverflow)?;
            self.m += 7;

            match (buf[0] & 128) == 0 {
                true => return Poll::Ready(Ok(self.i)),
                false => continue,
            }
        }
    }
}

pub enum IntegerDecoder {
    Decoding(DecodingInteger),
    Decoded(u64),
}

impl IntegerDecoder {
    pub const fn new(prefix: u8, n: u8) -> Self {
        match DecodingInteger::new(prefix, n) {
            Ok(decoding) => Self::Decoding(decoding),
            Err(i) => Self::Decoded(i),
        }
    }

    pub const fn is_decoded(&self) -> bool {
        matches!(self, Self::Decoded(_))
    }

    pub fn poll_decode(
        &mut self,
        stream: &mut (impl AsyncRead + Unpin),
        cx: &mut Context<'_>,
    ) -> Poll<Result<u64, DecodeStreamError>> {
        match &mut *self {
            Self::Decoded(i) => Poll::Ready(Ok(*i)),
            Self::Decoding(decoding) => {
                let i = ready!(decoding.poll_decode(stream, cx)?);
                *self = Self::Decoded(i);
                Poll::Ready(Ok(i))
            }
        }
    }
}

pub struct DecodingLiteral {
    length: u64,
    buf: BytesMut,
}

impl DecodingLiteral {
    pub fn new(length: u64) -> Self {
        Self {
            length,
            buf: BytesMut::new(),
        }
    }

    pub fn poll_decode(
        &mut self,
        stream: &mut (impl AsyncBufRead + Unpin),
        cx: &mut Context,
    ) -> Poll<Result<Bytes, DecodeStreamError>> {
        while self.length > self.buf.len() as u64 {
            let remaining = (self.length - self.buf.len() as u64) as usize;
            let chunk = ready!(Pin::new(&mut *stream).poll_fill_buf(cx))
                .map_err(DecodeStreamError::from_io_error)?;
            if chunk.is_empty() {
                return Poll::Ready(Err(DecodeError::Incomplete.into()));
            }
            let read = chunk.len().min(remaining);
            self.buf.extend_from_slice(&chunk[..read]);
            Pin::new(&mut *stream).consume(read);
        }
        Poll::Ready(Ok(mem::take(&mut self.buf).freeze()))
    }
}

/// Appendix B.  Huffman Code
///
///    The following Huffman code is used when encoding string literals with
///    a Huffman coding (see Section 5.2).
///
///    This Huffman code was generated from statistics obtained on a large
///    sample of HTTP headers.  It is a canonical Huffman code (see
///    [CANONICAL]) with some tweaking to ensure that no symbol has a unique
///    code length.
///
///    Each row in the table defines the code used to represent a symbol:
///
///    sym:  The symbol to be represented.  It is the decimal value of an
///       octet, possibly prepended with its ASCII representation.  A
///       specific symbol, "EOS", is used to indicate the end of a string
///       literal.
///
///    code as bits:  The Huffman code for the symbol represented as a
///       base-2 integer, aligned on the most significant bit (MSB).
///
///    code as hex:  The Huffman code for the symbol, represented as a
///       hexadecimal integer, aligned on the least significant bit (LSB).
///
///    len:  The number of bits for the code representing the symbol.
///
///    As an example, the code for the symbol 47 (corresponding to the ASCII
///    character "/") consists in the 6 bits "0", "1", "1", "0", "0", "0".
///    This corresponds to the value 0x18 (in hexadecimal) encoded in 6
///    bits.
///
///                                                         code
///                           code as bits                 as hex   len
///         sym              aligned to MSB                aligned   in
///                                                        to LSB   bits
///        (  0)  |11111111|11000                             1ff8  [13]
///        (  1)  |11111111|11111111|1011000                7fffd8  [23]
///        (  2)  |11111111|11111111|11111110|0010         fffffe2  [28]
///        (  3)  |11111111|11111111|11111110|0011         fffffe3  [28]
///        (  4)  |11111111|11111111|11111110|0100         fffffe4  [28]
///        (  5)  |11111111|11111111|11111110|0101         fffffe5  [28]
///        (  6)  |11111111|11111111|11111110|0110         fffffe6  [28]
///        (  7)  |11111111|11111111|11111110|0111         fffffe7  [28]
///        (  8)  |11111111|11111111|11111110|1000         fffffe8  [28]
///        (  9)  |11111111|11111111|11101010               ffffea  [24]
///        ( 10)  |11111111|11111111|11111111|111100      3ffffffc  [30]
///        ( 11)  |11111111|11111111|11111110|1001         fffffe9  [28]
///        ( 12)  |11111111|11111111|11111110|1010         fffffea  [28]
///        ( 13)  |11111111|11111111|11111111|111101      3ffffffd  [30]
///        ( 14)  |11111111|11111111|11111110|1011         fffffeb  [28]
///        ( 15)  |11111111|11111111|11111110|1100         fffffec  [28]
///        ( 16)  |11111111|11111111|11111110|1101         fffffed  [28]
///        ( 17)  |11111111|11111111|11111110|1110         fffffee  [28]
///        ( 18)  |11111111|11111111|11111110|1111         fffffef  [28]
///        ( 19)  |11111111|11111111|11111111|0000         ffffff0  [28]
///        ( 20)  |11111111|11111111|11111111|0001         ffffff1  [28]
///        ( 21)  |11111111|11111111|11111111|0010         ffffff2  [28]
///        ( 22)  |11111111|11111111|11111111|111110      3ffffffe  [30]
///        ( 23)  |11111111|11111111|11111111|0011         ffffff3  [28]
///        ( 24)  |11111111|11111111|11111111|0100         ffffff4  [28]
///        ( 25)  |11111111|11111111|11111111|0101         ffffff5  [28]
///        ( 26)  |11111111|11111111|11111111|0110         ffffff6  [28]
///        ( 27)  |11111111|11111111|11111111|0111         ffffff7  [28]
///        ( 28)  |11111111|11111111|11111111|1000         ffffff8  [28]
///        ( 29)  |11111111|11111111|11111111|1001         ffffff9  [28]
///        ( 30)  |11111111|11111111|11111111|1010         ffffffa  [28]
///        ( 31)  |11111111|11111111|11111111|1011         ffffffb  [28]
///    ' ' ( 32)  |010100                                       14  [ 6]
///    '!' ( 33)  |11111110|00                                 3f8  [10]
///    '"' ( 34)  |11111110|01                                 3f9  [10]
///    '#' ( 35)  |11111111|1010                               ffa  [12]
///    '$' ( 36)  |11111111|11001                             1ff9  [13]
///    '%' ( 37)  |010101                                       15  [ 6]
///    '&' ( 38)  |11111000                                     f8  [ 8]
///    ''' ( 39)  |11111111|010                                7fa  [11]
///    '(' ( 40)  |11111110|10                                 3fa  [10]
///    ')' ( 41)  |11111110|11                                 3fb  [10]
///    '*' ( 42)  |11111001                                     f9  [ 8]
///    '+' ( 43)  |11111111|011                                7fb  [11]
///    ',' ( 44)  |11111010                                     fa  [ 8]
///    '-' ( 45)  |010110                                       16  [ 6]
///    '.' ( 46)  |010111                                       17  [ 6]
///    '/' ( 47)  |011000                                       18  [ 6]
///    '0' ( 48)  |00000                                         0  [ 5]
///    '1' ( 49)  |00001                                         1  [ 5]
///    '2' ( 50)  |00010                                         2  [ 5]
///    '3' ( 51)  |011001                                       19  [ 6]
///    '4' ( 52)  |011010                                       1a  [ 6]
///    '5' ( 53)  |011011                                       1b  [ 6]
///    '6' ( 54)  |011100                                       1c  [ 6]
///    '7' ( 55)  |011101                                       1d  [ 6]
///    '8' ( 56)  |011110                                       1e  [ 6]
///    '9' ( 57)  |011111                                       1f  [ 6]
///    ':' ( 58)  |1011100                                      5c  [ 7]
///    ';' ( 59)  |11111011                                     fb  [ 8]
///    '<' ( 60)  |11111111|1111100                           7ffc  [15]
///    '=' ( 61)  |100000                                       20  [ 6]
///    '>' ( 62)  |11111111|1011                               ffb  [12]
///    '?' ( 63)  |11111111|00                                 3fc  [10]
///    '@' ( 64)  |11111111|11010                             1ffa  [13]
///    'A' ( 65)  |100001                                       21  [ 6]
///    'B' ( 66)  |1011101                                      5d  [ 7]
///    'C' ( 67)  |1011110                                      5e  [ 7]
///    'D' ( 68)  |1011111                                      5f  [ 7]
///    'E' ( 69)  |1100000                                      60  [ 7]
///    'F' ( 70)  |1100001                                      61  [ 7]
///    'G' ( 71)  |1100010                                      62  [ 7]
///    'H' ( 72)  |1100011                                      63  [ 7]
///    'I' ( 73)  |1100100                                      64  [ 7]
///    'J' ( 74)  |1100101                                      65  [ 7]
///    'K' ( 75)  |1100110                                      66  [ 7]
///    'L' ( 76)  |1100111                                      67  [ 7]
///    'M' ( 77)  |1101000                                      68  [ 7]
///    'N' ( 78)  |1101001                                      69  [ 7]
///    'O' ( 79)  |1101010                                      6a  [ 7]
///    'P' ( 80)  |1101011                                      6b  [ 7]
///    'Q' ( 81)  |1101100                                      6c  [ 7]
///    'R' ( 82)  |1101101                                      6d  [ 7]
///    'S' ( 83)  |1101110                                      6e  [ 7]
///    'T' ( 84)  |1101111                                      6f  [ 7]
///    'U' ( 85)  |1110000                                      70  [ 7]
///    'V' ( 86)  |1110001                                      71  [ 7]
///    'W' ( 87)  |1110010                                      72  [ 7]
///    'X' ( 88)  |11111100                                     fc  [ 8]
///    'Y' ( 89)  |1110011                                      73  [ 7]
///    'Z' ( 90)  |11111101                                     fd  [ 8]
///    '[' ( 91)  |11111111|11011                             1ffb  [13]
///    '\' ( 92)  |11111111|11111110|000                     7fff0  [19]
///    ']' ( 93)  |11111111|11100                             1ffc  [13]
///    '^' ( 94)  |11111111|111100                            3ffc  [14]
///    '_' ( 95)  |100010                                       22  [ 6]
///    '`' ( 96)  |11111111|1111101                           7ffd  [15]
///    'a' ( 97)  |00011                                         3  [ 5]
///    'b' ( 98)  |100011                                       23  [ 6]
///    'c' ( 99)  |00100                                         4  [ 5]
///    'd' (100)  |100100                                       24  [ 6]
///    'e' (101)  |00101                                         5  [ 5]
///    'f' (102)  |100101                                       25  [ 6]
///    'g' (103)  |100110                                       26  [ 6]
///    'h' (104)  |100111                                       27  [ 6]
///    'i' (105)  |00110                                         6  [ 5]
///    'j' (106)  |1110100                                      74  [ 7]
///    'k' (107)  |1110101                                      75  [ 7]
///    'l' (108)  |101000                                       28  [ 6]
///    'm' (109)  |101001                                       29  [ 6]
///    'n' (110)  |101010                                       2a  [ 6]
///    'o' (111)  |00111                                         7  [ 5]
///    'p' (112)  |101011                                       2b  [ 6]
///    'q' (113)  |1110110                                      76  [ 7]
///    'r' (114)  |101100                                       2c  [ 6]
///    's' (115)  |01000                                         8  [ 5]
///    't' (116)  |01001                                         9  [ 5]
///    'u' (117)  |101101                                       2d  [ 6]
///    'v' (118)  |1110111                                      77  [ 7]
///    'w' (119)  |1111000                                      78  [ 7]
///    'x' (120)  |1111001                                      79  [ 7]
///    'y' (121)  |1111010                                      7a  [ 7]
///    'z' (122)  |1111011                                      7b  [ 7]
///    '{' (123)  |11111111|1111110                           7ffe  [15]
///    '|' (124)  |11111111|100                                7fc  [11]
///    '}' (125)  |11111111|111101                            3ffd  [14]
///    '~' (126)  |11111111|11101                             1ffd  [13]
///        (127)  |11111111|11111111|11111111|1100         ffffffc  [28]
///        (128)  |11111111|11111110|0110                    fffe6  [20]
///        (129)  |11111111|11111111|010010                 3fffd2  [22]
///        (130)  |11111111|11111110|0111                    fffe7  [20]
///        (131)  |11111111|11111110|1000                    fffe8  [20]
///        (132)  |11111111|11111111|010011                 3fffd3  [22]
///        (133)  |11111111|11111111|010100                 3fffd4  [22]
///        (134)  |11111111|11111111|010101                 3fffd5  [22]
///        (135)  |11111111|11111111|1011001                7fffd9  [23]
///        (136)  |11111111|11111111|010110                 3fffd6  [22]
///        (137)  |11111111|11111111|1011010                7fffda  [23]
///        (138)  |11111111|11111111|1011011                7fffdb  [23]
///        (139)  |11111111|11111111|1011100                7fffdc  [23]
///        (140)  |11111111|11111111|1011101                7fffdd  [23]
///        (141)  |11111111|11111111|1011110                7fffde  [23]
///        (142)  |11111111|11111111|11101011               ffffeb  [24]
///        (143)  |11111111|11111111|1011111                7fffdf  [23]
///        (144)  |11111111|11111111|11101100               ffffec  [24]
///        (145)  |11111111|11111111|11101101               ffffed  [24]
///        (146)  |11111111|11111111|010111                 3fffd7  [22]
///        (147)  |11111111|11111111|1100000                7fffe0  [23]
///        (148)  |11111111|11111111|11101110               ffffee  [24]
///        (149)  |11111111|11111111|1100001                7fffe1  [23]
///        (150)  |11111111|11111111|1100010                7fffe2  [23]
///        (151)  |11111111|11111111|1100011                7fffe3  [23]
///        (152)  |11111111|11111111|1100100                7fffe4  [23]
///        (153)  |11111111|11111110|11100                  1fffdc  [21]
///        (154)  |11111111|11111111|011000                 3fffd8  [22]
///        (155)  |11111111|11111111|1100101                7fffe5  [23]
///        (156)  |11111111|11111111|011001                 3fffd9  [22]
///        (157)  |11111111|11111111|1100110                7fffe6  [23]
///        (158)  |11111111|11111111|1100111                7fffe7  [23]
///        (159)  |11111111|11111111|11101111               ffffef  [24]
///        (160)  |11111111|11111111|011010                 3fffda  [22]
///        (161)  |11111111|11111110|11101                  1fffdd  [21]
///        (162)  |11111111|11111110|1001                    fffe9  [20]
///        (163)  |11111111|11111111|011011                 3fffdb  [22]
///        (164)  |11111111|11111111|011100                 3fffdc  [22]
///        (165)  |11111111|11111111|1101000                7fffe8  [23]
///        (166)  |11111111|11111111|1101001                7fffe9  [23]
///        (167)  |11111111|11111110|11110                  1fffde  [21]
///        (168)  |11111111|11111111|1101010                7fffea  [23]
///        (169)  |11111111|11111111|011101                 3fffdd  [22]
///        (170)  |11111111|11111111|011110                 3fffde  [22]
///        (171)  |11111111|11111111|11110000               fffff0  [24]
///        (172)  |11111111|11111110|11111                  1fffdf  [21]
///        (173)  |11111111|11111111|011111                 3fffdf  [22]
///        (174)  |11111111|11111111|1101011                7fffeb  [23]
///        (175)  |11111111|11111111|1101100                7fffec  [23]
///        (176)  |11111111|11111111|00000                  1fffe0  [21]
///        (177)  |11111111|11111111|00001                  1fffe1  [21]
///        (178)  |11111111|11111111|100000                 3fffe0  [22]
///        (179)  |11111111|11111111|00010                  1fffe2  [21]
///        (180)  |11111111|11111111|1101101                7fffed  [23]
///        (181)  |11111111|11111111|100001                 3fffe1  [22]
///        (182)  |11111111|11111111|1101110                7fffee  [23]
///        (183)  |11111111|11111111|1101111                7fffef  [23]
///        (184)  |11111111|11111110|1010                    fffea  [20]
///        (185)  |11111111|11111111|100010                 3fffe2  [22]
///        (186)  |11111111|11111111|100011                 3fffe3  [22]
///        (187)  |11111111|11111111|100100                 3fffe4  [22]
///        (188)  |11111111|11111111|1110000                7ffff0  [23]
///        (189)  |11111111|11111111|100101                 3fffe5  [22]
///        (190)  |11111111|11111111|100110                 3fffe6  [22]
///        (191)  |11111111|11111111|1110001                7ffff1  [23]
///        (192)  |11111111|11111111|11111000|00           3ffffe0  [26]
///        (193)  |11111111|11111111|11111000|01           3ffffe1  [26]
///        (194)  |11111111|11111110|1011                    fffeb  [20]
///        (195)  |11111111|11111110|001                     7fff1  [19]
///        (196)  |11111111|11111111|100111                 3fffe7  [22]
///        (197)  |11111111|11111111|1110010                7ffff2  [23]
///        (198)  |11111111|11111111|101000                 3fffe8  [22]
///        (199)  |11111111|11111111|11110110|0            1ffffec  [25]
///        (200)  |11111111|11111111|11111000|10           3ffffe2  [26]
///        (201)  |11111111|11111111|11111000|11           3ffffe3  [26]
///        (202)  |11111111|11111111|11111001|00           3ffffe4  [26]
///        (203)  |11111111|11111111|11111011|110          7ffffde  [27]
///        (204)  |11111111|11111111|11111011|111          7ffffdf  [27]
///        (205)  |11111111|11111111|11111001|01           3ffffe5  [26]
///        (206)  |11111111|11111111|11110001               fffff1  [24]
///        (207)  |11111111|11111111|11110110|1            1ffffed  [25]
///        (208)  |11111111|11111110|010                     7fff2  [19]
///        (209)  |11111111|11111111|00011                  1fffe3  [21]
///        (210)  |11111111|11111111|11111001|10           3ffffe6  [26]
///        (211)  |11111111|11111111|11111100|000          7ffffe0  [27]
///        (212)  |11111111|11111111|11111100|001          7ffffe1  [27]
///        (213)  |11111111|11111111|11111001|11           3ffffe7  [26]
///        (214)  |11111111|11111111|11111100|010          7ffffe2  [27]
///        (215)  |11111111|11111111|11110010               fffff2  [24]
///        (216)  |11111111|11111111|00100                  1fffe4  [21]
///        (217)  |11111111|11111111|00101                  1fffe5  [21]
///        (218)  |11111111|11111111|11111010|00           3ffffe8  [26]
///        (219)  |11111111|11111111|11111010|01           3ffffe9  [26]
///        (220)  |11111111|11111111|11111111|1101         ffffffd  [28]
///        (221)  |11111111|11111111|11111100|011          7ffffe3  [27]
///        (222)  |11111111|11111111|11111100|100          7ffffe4  [27]
///        (223)  |11111111|11111111|11111100|101          7ffffe5  [27]
///        (224)  |11111111|11111110|1100                    fffec  [20]
///        (225)  |11111111|11111111|11110011               fffff3  [24]
///        (226)  |11111111|11111110|1101                    fffed  [20]
///        (227)  |11111111|11111111|00110                  1fffe6  [21]
///        (228)  |11111111|11111111|101001                 3fffe9  [22]
///        (229)  |11111111|11111111|00111                  1fffe7  [21]
///        (230)  |11111111|11111111|01000                  1fffe8  [21]
///        (231)  |11111111|11111111|1110011                7ffff3  [23]
///        (232)  |11111111|11111111|101010                 3fffea  [22]
///        (233)  |11111111|11111111|101011                 3fffeb  [22]
///        (234)  |11111111|11111111|11110111|0            1ffffee  [25]
///        (235)  |11111111|11111111|11110111|1            1ffffef  [25]
///        (236)  |11111111|11111111|11110100               fffff4  [24]
///        (237)  |11111111|11111111|11110101               fffff5  [24]
///        (238)  |11111111|11111111|11111010|10           3ffffea  [26]
///        (239)  |11111111|11111111|1110100                7ffff4  [23]
///        (240)  |11111111|11111111|11111010|11           3ffffeb  [26]
///        (241)  |11111111|11111111|11111100|110          7ffffe6  [27]
///        (242)  |11111111|11111111|11111011|00           3ffffec  [26]
///        (243)  |11111111|11111111|11111011|01           3ffffed  [26]
///        (244)  |11111111|11111111|11111100|111          7ffffe7  [27]
///        (245)  |11111111|11111111|11111101|000          7ffffe8  [27]
///        (246)  |11111111|11111111|11111101|001          7ffffe9  [27]
///        (247)  |11111111|11111111|11111101|010          7ffffea  [27]
///        (248)  |11111111|11111111|11111101|011          7ffffeb  [27]
///        (249)  |11111111|11111111|11111111|1110         ffffffe  [28]
///        (250)  |11111111|11111111|11111101|100          7ffffec  [27]
///        (251)  |11111111|11111111|11111101|101          7ffffed  [27]
///        (252)  |11111111|11111111|11111101|110          7ffffee  [27]
///        (253)  |11111111|11111111|11111101|111          7ffffef  [27]
///        (254)  |11111111|11111111|11111110|000          7fffff0  [27]
///        (255)  |11111111|11111111|11111011|10           3ffffee  [26]
///    EOS (256)  |11111111|11111111|11111111|111111      3fffffff  [30]
#[allow(clippy::zero_prefixed_literal)]
const HUFFMAN_CODES: &[(u32, u8)] = &[
    (0b_11111111_11000000_00000000_00000000, 13),
    (0b_11111111_11111111_10110000_00000000, 23),
    (0b_11111111_11111111_11111110_00100000, 28),
    (0b_11111111_11111111_11111110_00110000, 28),
    (0b_11111111_11111111_11111110_01000000, 28),
    (0b_11111111_11111111_11111110_01010000, 28),
    (0b_11111111_11111111_11111110_01100000, 28),
    (0b_11111111_11111111_11111110_01110000, 28),
    (0b_11111111_11111111_11111110_10000000, 28),
    (0b_11111111_11111111_11101010_00000000, 24),
    (0b_11111111_11111111_11111111_11110000, 30),
    (0b_11111111_11111111_11111110_10010000, 28),
    (0b_11111111_11111111_11111110_10100000, 28),
    (0b_11111111_11111111_11111111_11110100, 30),
    (0b_11111111_11111111_11111110_10110000, 28),
    (0b_11111111_11111111_11111110_11000000, 28),
    (0b_11111111_11111111_11111110_11010000, 28),
    (0b_11111111_11111111_11111110_11100000, 28),
    (0b_11111111_11111111_11111110_11110000, 28),
    (0b_11111111_11111111_11111111_00000000, 28),
    (0b_11111111_11111111_11111111_00010000, 28),
    (0b_11111111_11111111_11111111_00100000, 28),
    (0b_11111111_11111111_11111111_11111000, 30),
    (0b_11111111_11111111_11111111_00110000, 28),
    (0b_11111111_11111111_11111111_01000000, 28),
    (0b_11111111_11111111_11111111_01010000, 28),
    (0b_11111111_11111111_11111111_01100000, 28),
    (0b_11111111_11111111_11111111_01110000, 28),
    (0b_11111111_11111111_11111111_10000000, 28),
    (0b_11111111_11111111_11111111_10010000, 28),
    (0b_11111111_11111111_11111111_10100000, 28),
    (0b_11111111_11111111_11111111_10110000, 28),
    (0b_01010000_00000000_00000000_00000000, 06),
    (0b_11111110_00000000_00000000_00000000, 10),
    (0b_11111110_01000000_00000000_00000000, 10),
    (0b_11111111_10100000_00000000_00000000, 12),
    (0b_11111111_11001000_00000000_00000000, 13),
    (0b_01010100_00000000_00000000_00000000, 06),
    (0b_11111000_00000000_00000000_00000000, 08),
    (0b_11111111_01000000_00000000_00000000, 11),
    (0b_11111110_10000000_00000000_00000000, 10),
    (0b_11111110_11000000_00000000_00000000, 10),
    (0b_11111001_00000000_00000000_00000000, 08),
    (0b_11111111_01100000_00000000_00000000, 11),
    (0b_11111010_00000000_00000000_00000000, 08),
    (0b_01011000_00000000_00000000_00000000, 06),
    (0b_01011100_00000000_00000000_00000000, 06),
    (0b_01100000_00000000_00000000_00000000, 06),
    (0b_00000000_00000000_00000000_00000000, 05),
    (0b_00001000_00000000_00000000_00000000, 05),
    (0b_00010000_00000000_00000000_00000000, 05),
    (0b_01100100_00000000_00000000_00000000, 06),
    (0b_01101000_00000000_00000000_00000000, 06),
    (0b_01101100_00000000_00000000_00000000, 06),
    (0b_01110000_00000000_00000000_00000000, 06),
    (0b_01110100_00000000_00000000_00000000, 06),
    (0b_01111000_00000000_00000000_00000000, 06),
    (0b_01111100_00000000_00000000_00000000, 06),
    (0b_10111000_00000000_00000000_00000000, 07),
    (0b_11111011_00000000_00000000_00000000, 08),
    (0b_11111111_11111000_00000000_00000000, 15),
    (0b_10000000_00000000_00000000_00000000, 06),
    (0b_11111111_10110000_00000000_00000000, 12),
    (0b_11111111_00000000_00000000_00000000, 10),
    (0b_11111111_11010000_00000000_00000000, 13),
    (0b_10000100_00000000_00000000_00000000, 06),
    (0b_10111010_00000000_00000000_00000000, 07),
    (0b_10111100_00000000_00000000_00000000, 07),
    (0b_10111110_00000000_00000000_00000000, 07),
    (0b_11000000_00000000_00000000_00000000, 07),
    (0b_11000010_00000000_00000000_00000000, 07),
    (0b_11000100_00000000_00000000_00000000, 07),
    (0b_11000110_00000000_00000000_00000000, 07),
    (0b_11001000_00000000_00000000_00000000, 07),
    (0b_11001010_00000000_00000000_00000000, 07),
    (0b_11001100_00000000_00000000_00000000, 07),
    (0b_11001110_00000000_00000000_00000000, 07),
    (0b_11010000_00000000_00000000_00000000, 07),
    (0b_11010010_00000000_00000000_00000000, 07),
    (0b_11010100_00000000_00000000_00000000, 07),
    (0b_11010110_00000000_00000000_00000000, 07),
    (0b_11011000_00000000_00000000_00000000, 07),
    (0b_11011010_00000000_00000000_00000000, 07),
    (0b_11011100_00000000_00000000_00000000, 07),
    (0b_11011110_00000000_00000000_00000000, 07),
    (0b_11100000_00000000_00000000_00000000, 07),
    (0b_11100010_00000000_00000000_00000000, 07),
    (0b_11100100_00000000_00000000_00000000, 07),
    (0b_11111100_00000000_00000000_00000000, 08),
    (0b_11100110_00000000_00000000_00000000, 07),
    (0b_11111101_00000000_00000000_00000000, 08),
    (0b_11111111_11011000_00000000_00000000, 13),
    (0b_11111111_11111110_00000000_00000000, 19),
    (0b_11111111_11100000_00000000_00000000, 13),
    (0b_11111111_11110000_00000000_00000000, 14),
    (0b_10001000_00000000_00000000_00000000, 06),
    (0b_11111111_11111010_00000000_00000000, 15),
    (0b_00011000_00000000_00000000_00000000, 05),
    (0b_10001100_00000000_00000000_00000000, 06),
    (0b_00100000_00000000_00000000_00000000, 05),
    (0b_10010000_00000000_00000000_00000000, 06),
    (0b_00101000_00000000_00000000_00000000, 05),
    (0b_10010100_00000000_00000000_00000000, 06),
    (0b_10011000_00000000_00000000_00000000, 06),
    (0b_10011100_00000000_00000000_00000000, 06),
    (0b_00110000_00000000_00000000_00000000, 05),
    (0b_11101000_00000000_00000000_00000000, 07),
    (0b_11101010_00000000_00000000_00000000, 07),
    (0b_10100000_00000000_00000000_00000000, 06),
    (0b_10100100_00000000_00000000_00000000, 06),
    (0b_10101000_00000000_00000000_00000000, 06),
    (0b_00111000_00000000_00000000_00000000, 05),
    (0b_10101100_00000000_00000000_00000000, 06),
    (0b_11101100_00000000_00000000_00000000, 07),
    (0b_10110000_00000000_00000000_00000000, 06),
    (0b_01000000_00000000_00000000_00000000, 05),
    (0b_01001000_00000000_00000000_00000000, 05),
    (0b_10110100_00000000_00000000_00000000, 06),
    (0b_11101110_00000000_00000000_00000000, 07),
    (0b_11110000_00000000_00000000_00000000, 07),
    (0b_11110010_00000000_00000000_00000000, 07),
    (0b_11110100_00000000_00000000_00000000, 07),
    (0b_11110110_00000000_00000000_00000000, 07),
    (0b_11111111_11111100_00000000_00000000, 15),
    (0b_11111111_10000000_00000000_00000000, 11),
    (0b_11111111_11110100_00000000_00000000, 14),
    (0b_11111111_11101000_00000000_00000000, 13),
    (0b_11111111_11111111_11111111_11000000, 28),
    (0b_11111111_11111110_01100000_00000000, 20),
    (0b_11111111_11111111_01001000_00000000, 22),
    (0b_11111111_11111110_01110000_00000000, 20),
    (0b_11111111_11111110_10000000_00000000, 20),
    (0b_11111111_11111111_01001100_00000000, 22),
    (0b_11111111_11111111_01010000_00000000, 22),
    (0b_11111111_11111111_01010100_00000000, 22),
    (0b_11111111_11111111_10110010_00000000, 23),
    (0b_11111111_11111111_01011000_00000000, 22),
    (0b_11111111_11111111_10110100_00000000, 23),
    (0b_11111111_11111111_10110110_00000000, 23),
    (0b_11111111_11111111_10111000_00000000, 23),
    (0b_11111111_11111111_10111010_00000000, 23),
    (0b_11111111_11111111_10111100_00000000, 23),
    (0b_11111111_11111111_11101011_00000000, 24),
    (0b_11111111_11111111_10111110_00000000, 23),
    (0b_11111111_11111111_11101100_00000000, 24),
    (0b_11111111_11111111_11101101_00000000, 24),
    (0b_11111111_11111111_01011100_00000000, 22),
    (0b_11111111_11111111_11000000_00000000, 23),
    (0b_11111111_11111111_11101110_00000000, 24),
    (0b_11111111_11111111_11000010_00000000, 23),
    (0b_11111111_11111111_11000100_00000000, 23),
    (0b_11111111_11111111_11000110_00000000, 23),
    (0b_11111111_11111111_11001000_00000000, 23),
    (0b_11111111_11111110_11100000_00000000, 21),
    (0b_11111111_11111111_01100000_00000000, 22),
    (0b_11111111_11111111_11001010_00000000, 23),
    (0b_11111111_11111111_01100100_00000000, 22),
    (0b_11111111_11111111_11001100_00000000, 23),
    (0b_11111111_11111111_11001110_00000000, 23),
    (0b_11111111_11111111_11101111_00000000, 24),
    (0b_11111111_11111111_01101000_00000000, 22),
    (0b_11111111_11111110_11101000_00000000, 21),
    (0b_11111111_11111110_10010000_00000000, 20),
    (0b_11111111_11111111_01101100_00000000, 22),
    (0b_11111111_11111111_01110000_00000000, 22),
    (0b_11111111_11111111_11010000_00000000, 23),
    (0b_11111111_11111111_11010010_00000000, 23),
    (0b_11111111_11111110_11110000_00000000, 21),
    (0b_11111111_11111111_11010100_00000000, 23),
    (0b_11111111_11111111_01110100_00000000, 22),
    (0b_11111111_11111111_01111000_00000000, 22),
    (0b_11111111_11111111_11110000_00000000, 24),
    (0b_11111111_11111110_11111000_00000000, 21),
    (0b_11111111_11111111_01111100_00000000, 22),
    (0b_11111111_11111111_11010110_00000000, 23),
    (0b_11111111_11111111_11011000_00000000, 23),
    (0b_11111111_11111111_00000000_00000000, 21),
    (0b_11111111_11111111_00001000_00000000, 21),
    (0b_11111111_11111111_10000000_00000000, 22),
    (0b_11111111_11111111_00010000_00000000, 21),
    (0b_11111111_11111111_11011010_00000000, 23),
    (0b_11111111_11111111_10000100_00000000, 22),
    (0b_11111111_11111111_11011100_00000000, 23),
    (0b_11111111_11111111_11011110_00000000, 23),
    (0b_11111111_11111110_10100000_00000000, 20),
    (0b_11111111_11111111_10001000_00000000, 22),
    (0b_11111111_11111111_10001100_00000000, 22),
    (0b_11111111_11111111_10010000_00000000, 22),
    (0b_11111111_11111111_11100000_00000000, 23),
    (0b_11111111_11111111_10010100_00000000, 22),
    (0b_11111111_11111111_10011000_00000000, 22),
    (0b_11111111_11111111_11100010_00000000, 23),
    (0b_11111111_11111111_11111000_00000000, 26),
    (0b_11111111_11111111_11111000_01000000, 26),
    (0b_11111111_11111110_10110000_00000000, 20),
    (0b_11111111_11111110_00100000_00000000, 19),
    (0b_11111111_11111111_10011100_00000000, 22),
    (0b_11111111_11111111_11100100_00000000, 23),
    (0b_11111111_11111111_10100000_00000000, 22),
    (0b_11111111_11111111_11110110_00000000, 25),
    (0b_11111111_11111111_11111000_10000000, 26),
    (0b_11111111_11111111_11111000_11000000, 26),
    (0b_11111111_11111111_11111001_00000000, 26),
    (0b_11111111_11111111_11111011_11000000, 27),
    (0b_11111111_11111111_11111011_11100000, 27),
    (0b_11111111_11111111_11111001_01000000, 26),
    (0b_11111111_11111111_11110001_00000000, 24),
    (0b_11111111_11111111_11110110_10000000, 25),
    (0b_11111111_11111110_01000000_00000000, 19),
    (0b_11111111_11111111_00011000_00000000, 21),
    (0b_11111111_11111111_11111001_10000000, 26),
    (0b_11111111_11111111_11111100_00000000, 27),
    (0b_11111111_11111111_11111100_00100000, 27),
    (0b_11111111_11111111_11111001_11000000, 26),
    (0b_11111111_11111111_11111100_01000000, 27),
    (0b_11111111_11111111_11110010_00000000, 24),
    (0b_11111111_11111111_00100000_00000000, 21),
    (0b_11111111_11111111_00101000_00000000, 21),
    (0b_11111111_11111111_11111010_00000000, 26),
    (0b_11111111_11111111_11111010_01000000, 26),
    (0b_11111111_11111111_11111111_11010000, 28),
    (0b_11111111_11111111_11111100_01100000, 27),
    (0b_11111111_11111111_11111100_10000000, 27),
    (0b_11111111_11111111_11111100_10100000, 27),
    (0b_11111111_11111110_11000000_00000000, 20),
    (0b_11111111_11111111_11110011_00000000, 24),
    (0b_11111111_11111110_11010000_00000000, 20),
    (0b_11111111_11111111_00110000_00000000, 21),
    (0b_11111111_11111111_10100100_00000000, 22),
    (0b_11111111_11111111_00111000_00000000, 21),
    (0b_11111111_11111111_01000000_00000000, 21),
    (0b_11111111_11111111_11100110_00000000, 23),
    (0b_11111111_11111111_10101000_00000000, 22),
    (0b_11111111_11111111_10101100_00000000, 22),
    (0b_11111111_11111111_11110111_00000000, 25),
    (0b_11111111_11111111_11110111_10000000, 25),
    (0b_11111111_11111111_11110100_00000000, 24),
    (0b_11111111_11111111_11110101_00000000, 24),
    (0b_11111111_11111111_11111010_10000000, 26),
    (0b_11111111_11111111_11101000_00000000, 23),
    (0b_11111111_11111111_11111010_11000000, 26),
    (0b_11111111_11111111_11111100_11000000, 27),
    (0b_11111111_11111111_11111011_00000000, 26),
    (0b_11111111_11111111_11111011_01000000, 26),
    (0b_11111111_11111111_11111100_11100000, 27),
    (0b_11111111_11111111_11111101_00000000, 27),
    (0b_11111111_11111111_11111101_00100000, 27),
    (0b_11111111_11111111_11111101_01000000, 27),
    (0b_11111111_11111111_11111101_01100000, 27),
    (0b_11111111_11111111_11111111_11100000, 28),
    (0b_11111111_11111111_11111101_10000000, 27),
    (0b_11111111_11111111_11111101_10100000, 27),
    (0b_11111111_11111111_11111101_11000000, 27),
    (0b_11111111_11111111_11111101_11100000, 27),
    (0b_11111111_11111111_11111110_00000000, 27),
    (0b_11111111_11111111_11111011_10000000, 26),
];

#[derive(Debug, Clone, Copy)]
struct HuffmanCode {
    symbol: u8,
    code: u32,
    length: u8,
}

impl HuffmanCode {
    fn iter() -> impl Iterator<Item = HuffmanCode> {
        HUFFMAN_CODES
            .iter()
            .enumerate()
            .map(|(symbol, &(code, length))| HuffmanCode {
                symbol: symbol as _,
                code,
                length,
            })
    }

    fn tree() -> &'static [HuffmanCode] {
        static HUFFMAN_TREE: OnceLock<Vec<HuffmanCode>> = OnceLock::new();
        HUFFMAN_TREE.get_or_init(|| {
            let mut tree = HuffmanCode::iter().collect::<Vec<_>>();
            tree.sort_by(|a, b| a.code.cmp(&b.code));
            tree
        })
    }

    fn try_decode(code: u32) -> Option<HuffmanCode> {
        let index = match Self::tree().binary_search_by(|c| c.code.cmp(&code)) {
            Ok(index) => index,
            Err(0) => return None,
            Err(index) => index - 1,
        };

        let matched_code = Self::tree()[index];
        // For code, only the first `matched_code.length` bits are valid, the rest are all 0.
        let mask = u32::MAX << (32 - matched_code.length);
        (code & mask == matched_code.code).then_some(matched_code)
    }
}

pub struct HuffmanTree {
    // sort by code
    inner: Vec<HuffmanCode>,
}

pub struct DecodingHuffman {
    read: Range<u64>,
    // count in bits
    decoding: u8,
    buffer: u32,
    decoded: BytesMut,
}

impl DecodingHuffman {
    pub fn new(len: u64) -> Self {
        Self {
            read: 0..len,
            decoding: 0,
            buffer: 0,
            decoded: BytesMut::new(),
        }
    }

    pub fn poll_decode(
        &mut self,
        stream: &mut (impl AsyncBufRead + Unpin),
        cx: &mut Context,
    ) -> Poll<Result<Bytes, DecodeStreamError>> {
        loop {
            // more data can be decoded
            while self.read.end > self.read.start && self.decoding <= 24 {
                let chunk = ready!(Pin::new(&mut *stream).poll_fill_buf(cx))
                    .map_err(DecodeStreamError::from_io_error)?;
                match chunk {
                    [] => return Poll::Ready(Err(DecodeError::Incomplete.into())),
                    chunk => {
                        // Avoid buffer overflow
                        let read = ((self.read.end - self.read.start) as usize)
                            .min((32 - self.decoding).div_ceil(8) as usize)
                            .min(chunk.len());
                        for &byte in &chunk[..read] {
                            self.buffer |= (byte as u32) << (24 - self.decoding);
                            self.decoding += 8;
                        }
                        self.read.start += read as u64;
                        Pin::new(&mut *stream).consume(read);
                    }
                }
            }
            while self.decoding > 0 {
                match HuffmanCode::try_decode(self.buffer) {
                    Some(HuffmanCode { symbol, length, .. }) if self.decoding >= length => {
                        self.buffer <<= length;
                        self.decoding -= length;
                        self.decoded.put_u8(symbol);
                    }

                    _ => break,
                }
            }
            if self.read.start == self.read.end {
                // no more data to read
                if self.buffer.leading_ones() as u8 != self.decoding {
                    return Poll::Ready(Err(DecodeError::HuffmanPadding.into()));
                }
                return Poll::Ready(Ok(self.decoded.split().freeze()));
            }
        }
    }
}

pub enum DecodingLengthString {
    Literal {
        length: IntegerDecoder,
        string: Option<DecodingLiteral>,
    },
    Huffman {
        length: IntegerDecoder,
        string: Option<DecodingHuffman>,
    },
}

impl DecodingLengthString {
    pub fn new(prefix: u8, n: u8) -> Self {
        match (prefix >> (n - 1)) & 1 {
            0 => DecodingLengthString::Literal {
                length: IntegerDecoder::new(prefix, n - 1),
                string: None,
            },
            1 => DecodingLengthString::Huffman {
                length: IntegerDecoder::new(prefix, n - 1),
                string: None,
            },
            _ => unreachable!("H bit must be 0 or 1"),
        }
    }

    pub fn poll_decode(
        &mut self,
        stream: &mut (impl AsyncBufRead + Unpin),
        cx: &mut Context,
    ) -> Poll<Result<Bytes, DecodeStreamError>> {
        match self {
            DecodingLengthString::Literal { length, string } => {
                if string.is_none() {
                    let len = ready!(length.poll_decode(stream, cx))?;
                    *string = Some(DecodingLiteral::new(len));
                }
                match string {
                    Some(string) => string.poll_decode(stream, cx),
                    None => unreachable!(),
                }
            }
            DecodingLengthString::Huffman { length, string } => {
                if string.is_none() {
                    let len = ready!(length.poll_decode(stream, cx))?;
                    *string = Some(DecodingHuffman::new(len));
                }
                match string {
                    Some(string) => string.poll_decode(stream, cx),
                    None => unreachable!(),
                }
            }
        }
    }
}
